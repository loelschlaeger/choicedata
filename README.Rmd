---
output: github_document
bibliography: inst/REFERENCES.bib
link-citations: yes
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Choice Data in R <img src="man/figures/logo.png" align="right" height="139"/>

<!-- badges: start -->

[![CRAN status](https://www.r-pkg.org/badges/version/choicedata)](https://CRAN.R-project.org/package=choicedata) 
[![R-CMD-check](https://github.com/loelschlaeger/choicedata/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/loelschlaeger/choicedata/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/loelschlaeger/choicedata/graph/badge.svg)](https://app.codecov.io/gh/loelschlaeger/choicedata)
<!-- badges: end -->

The `{choicedata}` package simplifies working with choice data in [R](https://www.r-project.org/).

## Package design

The package breaks down the process of modeling choice data into a series of steps. Each step is represented by an object that contains the necessary information for the subsequent step.

![](man/figures/choicedata_flowchart.png)

- [`choice_formula`](https://loelschlaeger.de/choicedata/reference/choice_formula.html): the choice model formula.

- [`choice_alternatives`](https://loelschlaeger.de/choicedata/reference/choice_alternatives.html): the set of choice alternatives.

- [`choice_effects`](https://loelschlaeger.de/choicedata/reference/choice_effects.html): the choice effects, defined by `choice_alternatives` and `choice_formula`.

- [`choice_parameters`](https://loelschlaeger.de/choicedata/reference/choice_parameters.html): the model parameters, determined by `choice_effects` and estimated via `choice_likelihood`.

- [`choice_identifiers`](https://loelschlaeger.de/choicedata/reference/choice_identifiers.html): the identifiers for deciders and choice occasions.

- [`choice_preferences`](https://loelschlaeger.de/choicedata/reference/choice_preferences.html): the deciders' choice preferences, identified by `choice_identifiers`.

- [`choice_responses`](https://loelschlaeger.de/choicedata/reference/choice_responses.html): the choice responses, influenced by `choice_preferences`.

- [`choice_covariates`](https://loelschlaeger.de/choicedata/reference/choice_covariates.html): the choice covariates.

- [`choice_data`](https://loelschlaeger.de/choicedata/reference/choice_data.html): the choice data, built by `choice_covariates` and `choice_responses`.

- [`choice_probabilities`](https://loelschlaeger.de/choicedata/reference/choice_probabilities.html): the choice probabilities, computed from `choice_data` and `choice_parameters`.

- [`choice_likelihood`](https://loelschlaeger.de/choicedata/reference/choice_likelihood.html): the likelihood of the choice model, formed by `choice_probabilities`.

The objects are designed to be modular and can be combined in various ways to create a range of modeling workflows.

## Examples

### Empirical data

The `travel_mode_choice` data set contains the revealed preferences of 210 travelers choosing between plane, train, bus, and car. We can transform the data from long to wide format, or construct model design matrices:

```{r travel-example}
library("choicedata")

travel_mode_choice

long_to_wide(
  data_frame = travel_mode_choice,
  column_alternative = "mode",
  column_decider = "individual"
)

mode_effects <- choice_effects(
  choice_formula = choice_formula(
    formula = choice ~ cost | income + size | travel + wait,
    error_term = "probit"
  ),
  choice_alternatives = choice_alternatives(
    J = 4,
    alternatives = unique(travel_mode_choice$mode)
  )
)

mode_data <- choice_data(
  data_frame = travel_mode_choice,
  format = "long",
  column_choice = "choice",
  column_decider = "individual",
  column_alternative = "mode",
  column_ac_covariates = c("income", "size"),
  column_as_covariates = c("wait", "cost", "travel")
)

design_matrices <- design_matrices(mode_data, mode_effects)
design_matrices[[1]]
```

### Simulated choice

`generate_choice_data()` makes it straightforward to simulate choice data. The example below simulates 200 ranking tasks with three alternatives and recovers the data-generating parameters via numerical optimization of the
likelihood:

```{r simulate-example}
library("choicedata")

set.seed(1)

sim_effects <- choice_effects(
  choice_formula = choice_formula(
    formula = choice ~ A | B | C,
    error_term = "logit"
  ),
  choice_alternatives = choice_alternatives(
    J = 3,
    alternatives = c("A", "B", "C")
  )
)

sim_parameters <- generate_choice_parameters(sim_effects)

(sim_data <- generate_choice_data(
  choice_effects = sim_effects,
  choice_identifiers = generate_choice_identifiers(N = 200),
  choice_parameters = sim_parameters,
  choice_type = "ranked"
))

sim_likelihood <- choice_likelihood(
  choice_data = sim_data,
  choice_effects = sim_effects
)

objective <- sim_likelihood$objective
true_vector <- switch_parameter_space(
  choice_parameters = sim_parameters,
  choice_effects = sim_effects
)

fit <- stats::optim(
  par = stats::rnorm(length(true_vector)),
  fn = function(par) {
    objective(choice_parameters = par, logarithm = TRUE, negative = TRUE)
  }
)

estimated_parameters <- switch_parameter_space(
  choice_parameters = fit$par,
  choice_effects = sim_effects
)

data.frame(dgp = true_vector, estimated = fit$par)
```

## Installation

You can install the released package version from [CRAN](https://CRAN.R-project.org) with:

```{r, install, eval = FALSE}
install.packages("choicedata")
```

## Related work

`{Rprobit}` [@Bauer2023] provides maximum approximated composite marginal likelihood estimation for efficient probit choice modeling.  

`{RprobitB}` [@Oelschlaeger2025] provides Bayesian tools for estimating probit models.

## Contact

You have a question, found a bug, request a feature, want to give feedback, or like to contribute? [Please file an issue on GitHub](https://github.com/loelschlaeger/choicedata/issues/new/choose).

## References
